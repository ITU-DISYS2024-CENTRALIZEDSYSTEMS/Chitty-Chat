% report.tex

\documentclass[a4paper,11pt]{article}

% Import packages
\usepackage[a4paper]{geometry}
\usepackage[utf8]{inputenc}
\usepackage{amsmath}
\usepackage{amssymb}
\usepackage{enumerate}

\usepackage{graphicx}


% Change enumerate environments you use letters
\renewcommand{\theenumi}{\alph{enumi}}

% Set title, author name and date
\title{Chitty-Chat}
\author{Johannes JÃ¸rgensen, Kevin Skovgaard Gravesen} 
\date{\today}

\begin{document} 

\maketitle

\subsection*{Streaming in Chitty-Chat}
This version of Chitty-Chat is implemented using bidirectional streaming. Which allows for messages to be sent over a single stream.
Every message include the author who send said message. When a message goes from the client only the id is sent, but is changed to the name when the server broadcasts.

Chitty-Chat could also be implemented using server-side streaming with an publish endpoint.
A client could then subscribe to the message stream, where the server will send (broadcast) the published messages.
Another service endpoint would then be used to publish the messages.
This would also allow for different Author signup and TextMessage types in the proto file, where the first text message currently is handled as is if it were an author.

\subsection*{Describe your system architecture - do you have a server-client architecture, peer-to-peer, or something else?}
We have implemented our Chitty-Chat program throught the server-client architecture. 
This means that a server is launched and is only responsible for the communication between different clients. This means that the clients are only responsible for
sending acceptable data from the client to the server.

\subsection*{Describe what  RPC methods are implemented, of what type, and what messages types are used for communication}
We have implemented a single RPC method called \verb|JoinConversation| that both takes and return a \textit{stream} of type \verb|Message|.
The \verb|Message| type is the message type used for communication. It contains the fields:
\begin{itemize}
    \item \verb|timestamp|: A Lamport timestamp
    \item \verb|username|: The username of the sender
    \item \verb|content|: The content of the message
\end{itemize} 

\subsection*{Describe how you have implemented the calculation of the Lamport timestamps}
Both the server and the client have a \verb|Lamport| clock initilized on start, that is set to \verb|0|. This is also the case for newcomers that connect to the server. 
The \verb|Lamport| clock is handled with these conditions:\\
\textbf{Client:}
\begin{itemize}
    \item When a client sends a message, the \verb|Lamport| clock is incremented by \verb|1|.
    \item When a client receives a message, the \verb|Lamport| clock is incremented by \verb|1| if the timestamp of the received message is greater than the current \verb|Lamport| clock.
\end{itemize}
\textbf{Server:}
\begin{itemize}
    \item When the server receives a message, the \verb|Lamport| clock is incremented by \verb|1| if the timestamp of the received message is greater than the current \verb|Lamport| clock.
    \item When the server broadcasts a message, the \verb|Lamport| will be incremented by \verb|1|.
    \item If a client disconnectes from the server, \verb|Lamport| clock is incremented by \verb|1| - Then the server will broadcast the disconnection.
    \item If a client connects to the server, \verb|Lamport| clock is incremented by \verb|1|- Then the server will broadcast the disconnection.
\end{itemize}

\subsection*{Provide a diagram, that traces a sequence of RPC calls together with the Lamport timestamps}
\includegraphics[width=\textwidth]{chat.png}
\begin{enumerate}
        \setlength{\itemsep}{1pt}
        \setlength{\parskip}{0pt}
        \item[1 - \textbf{Server \;}]Starting
        \item[2 - \textbf{Client 1}] Joined the conversation
        \item[3 - \textbf{Client 2}] Joined the conversation
        \item[4 - \textbf{Client 1}] Sends a message
        \item[5 - \textbf{Client 2}] Leaves the conversation
    \end{enumerate}

\subsection*{Git}
[GitHub](https://github.com/ITU-DISYS2024-CENTRALIZEDSYSTEMS/Chitty-Chat)

\subsection*{Appendix}

\subsubsection*{Lamport logs}
Server:
2024/10/22 14:32:31 Info | Client 1 | Joined Chitty-Chat | Lamport time 2
2024/10/22 14:32:31 Broadcasting | Client 1 | joined Chitty-Chat | Lamport time 3
2024/10/22 14:32:42 Info | Client 2 | Joined Chitty-Chat | Lamport time 4
2024/10/22 14:32:42 Broadcasting | Client 2 | joined Chitty-Chat | Lamport time 5
2024/10/22 14:32:58 Info | Client 1 | Sent a message | Lamport time 8
2024/10/22 14:32:58 Broadcasting | Client 1 | Hello world! | Lamport time 9
2024/10/22 14:33:00 Info | Client 2 | Dropped the connection! | Lamport time 10
2024/10/22 14:33:00 Broadcasting | Client 2 | left Chitty-Chat | Lamport time 12

Client 1:
2024/10/22 14:32:31 Client 1 | joined Chitty-Chat | Lamport time 4
2024/10/22 14:32:42 Client 2 | joined Chitty-Chat | Lamport time 6
2024/10/22 14:32:58 Client 1 | Hello world! | Lamport time 10
2024/10/22 14:33:00 Client 2 | left Chitty-Chat | Lamport time 13

Client 2:
2024/10/22 14:32:42 Client 2 | joined Chitty-Chat | Lamport time 6
2024/10/22 14:32:58 Client 1 | Hello world! | Lamport time 10

\end{document}